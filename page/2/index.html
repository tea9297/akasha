<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/akasha/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/akasha/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/akasha/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/akasha/images/logo.svg" color="#222">

<link rel="stylesheet" href="/akasha/css/main.css">


<link rel="stylesheet" href="/akasha/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tea9297.github.io","root":"/akasha/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="akasha 0.9 使用手冊">
<meta property="og:url" content="https://tea9297.github.io/akasha/page/2/index.html">
<meta property="og:site_name" content="akasha 0.9 使用手冊">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Chih Chuan Chang&lt;ccchang@iii.org.tw&gt;">
<meta property="article:tag" content="akasha, manual, llm, rag">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://tea9297.github.io/akasha/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title>akasha 0.9 使用手冊</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/akasha/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">akasha 0.9 使用手冊</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">akasha 0.9 manual</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/akasha/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/akasha/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/27/websearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/27/websearch/" class="post-title-link" itemprop="url">websearch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-27 22:59:59" itemprop="dateCreated datePublished" datetime="2024-12-27T22:59:59+08:00">2024-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 22:14:53" itemprop="dateModified" datetime="2025-04-22T22:14:53+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E5%8A%9F%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">功能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="websearch"><a href="#websearch" class="headerlink" title="websearch"></a>websearch</h2><p><code>websearch</code> 是一個結合網頁搜尋與語言模型回答的工具。它會根據使用者的問題在網路上搜尋相關資訊，並使用語言模型整合搜尋結果來回答問題。<code>websearch</code> 支援多種搜尋引擎與語言，並提供詳細的日誌記錄功能。 </p>
<p><em><strong>除了wiki，其他搜尋方法皆需要輸入搜尋引擎的API_KEY到.env檔或環境變數中</strong></em></p>
<ul>
<li>SERPER:  SERPER_API_KEY</li>
<li>BRAVE:  BRAVE_API_KEY</li>
<li>TAVILY: TAVILY_API_KEY</li>
</ul>
<h3 id="websearch-功能"><a href="#websearch-功能" class="headerlink" title="websearch 功能"></a>websearch 功能</h3><ol>
<li><strong>網頁搜尋</strong>：支援多種搜尋引擎，包括 <code>wiki</code>、<code>serper</code>、<code>tavily</code> 和 <code>brave</code>。</li>
<li><strong>日誌保存</strong>：支持保存執行過程與結果的日誌，便於後續分析。</li>
<li><strong>流式輸出</strong>：支援流式輸出回答，適合需要即時回應的場景。</li>
</ol>
<hr>
<h3 id="websearch-範例"><a href="#websearch-範例" class="headerlink" title="websearch 範例"></a>websearch 範例</h3><h4 id="使用-serper-搜尋引擎進行搜尋"><a href="#使用-serper-搜尋引擎進行搜尋" class="headerlink" title="使用 serper 搜尋引擎進行搜尋"></a>使用 <code>serper</code> 搜尋引擎進行搜尋</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"></span><br><span class="line">wb = akasha.websearch(</span><br><span class="line">    model=<span class="string">&quot;openai:gpt-4o&quot;</span>,</span><br><span class="line">    language=<span class="string">&quot;ch&quot;</span>,</span><br><span class="line">    search_engine=<span class="string">&quot;serper&quot;</span>,</span><br><span class="line">    search_num=<span class="number">5</span>,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    keep_logs=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用搜尋引擎回答問題</span></span><br><span class="line">res = wb(<span class="string">&quot;工業4.0是什麼?&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存日誌</span></span><br><span class="line">wb.save_logs(<span class="string">&quot;wb.json&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="使用流式輸出回答"><a href="#使用流式輸出回答" class="headerlink" title="使用流式輸出回答"></a>使用流式輸出回答</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 啟用流式輸出</span></span><br><span class="line">st = wb(<span class="string">&quot;工業4.0是什麼?&quot;</span>, stream=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐步輸出回答</span></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> st:</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="websearch-參數"><a href="#websearch-參數" class="headerlink" title="websearch 參數"></a>websearch 參數</h3><h4 id="初始化參數"><a href="#初始化參數" class="headerlink" title="初始化參數"></a>初始化參數</h4><h5 id="model-str"><a href="#model-str" class="headerlink" title="model: str"></a>model: str</h5><p>使用的語言模型，例如 <code>&quot;openai:gpt-4o&quot;</code> 或 <code>&quot;openai:gpt-3.5-turbo&quot;</code>。</p>
<h5 id="language-str"><a href="#language-str" class="headerlink" title="language: str"></a>language: str</h5><p>搜尋語言與地區，支持 <code>&quot;en&quot;</code>（英文）或 <code>&quot;ch&quot;</code>（中文）。</p>
<h5 id="search-engine-str"><a href="#search-engine-str" class="headerlink" title="search_engine: str"></a>search_engine: str</h5><p>使用的搜尋引擎，支持：</p>
<ul>
<li><code>&quot;wiki&quot;</code>：維基百科搜尋。</li>
<li><code>&quot;serper&quot;</code>：Google 搜尋 API（需申請 API 金鑰）。</li>
<li><code>&quot;tavily&quot;</code>：Tavily 搜尋 API（需申請 API 金鑰）。</li>
<li><code>&quot;brave&quot;</code>：Brave 搜尋 API（需申請 API 金鑰）。</li>
</ul>
<h5 id="search-num-int"><a href="#search-num-int" class="headerlink" title="search_num: int"></a>search_num: int</h5><p>搜尋結果的數量。</p>
<h5 id="max-input-tokens-int"><a href="#max-input-tokens-int" class="headerlink" title="max_input_tokens: int"></a>max_input_tokens: int</h5><p>單次輸入模型的最大 token 數。</p>
<h5 id="max-output-tokens-int"><a href="#max-output-tokens-int" class="headerlink" title="max_output_tokens: int"></a>max_output_tokens: int</h5><p>模型輸出的最大 token 數。</p>
<h5 id="temperature-float"><a href="#temperature-float" class="headerlink" title="temperature: float"></a>temperature: float</h5><p>語言模型的隨機性參數，範圍為 0.0 到 1.0。</p>
<h5 id="system-prompt-str"><a href="#system-prompt-str" class="headerlink" title="system_prompt: str"></a>system_prompt: str</h5><p>指示語言模型的輸出格式需求。</p>
<h5 id="keep-logs-bool"><a href="#keep-logs-bool" class="headerlink" title="keep_logs: bool"></a>keep_logs: bool</h5><p>是否保存執行過程與結果的日誌。</p>
<h5 id="verbose-bool"><a href="#verbose-bool" class="headerlink" title="verbose: bool"></a>verbose: bool</h5><p>是否顯示詳細的執行過程。</p>
<h5 id="stream-bool"><a href="#stream-bool" class="headerlink" title="stream: bool"></a>stream: bool</h5><p>是否啟用流式輸出。</p>
<h5 id="env-file-str"><a href="#env-file-str" class="headerlink" title="env_file: str"></a>env_file: str</h5><p>指定 <code>.env</code> 環境設定檔的路徑。</p>
<hr>
<h3 id="call-參數"><a href="#call-參數" class="headerlink" title="call 參數"></a><strong>call</strong> 參數</h3><h5 id="prompt-str"><a href="#prompt-str" class="headerlink" title="prompt: str"></a>prompt: str</h5><p>使用者的問題。</p>
<h5 id="stream-bool-1"><a href="#stream-bool-1" class="headerlink" title="stream: bool"></a>stream: bool</h5><p>是否啟用流式輸出。</p>
<h5 id="search-engine-str-1"><a href="#search-engine-str-1" class="headerlink" title="search_engine: str"></a>search_engine: str</h5><p>指定搜尋引擎，支持 <code>&quot;wiki&quot;</code>、<code>&quot;serper&quot;</code>、<code>&quot;tavily&quot;</code> 和 <code>&quot;brave&quot;</code>。</p>
<h5 id="search-num-int-1"><a href="#search-num-int-1" class="headerlink" title="search_num: int"></a>search_num: int</h5><p>搜尋結果的數量。</p>
<h5 id="language-str-1"><a href="#language-str-1" class="headerlink" title="language: str"></a>language: str</h5><p>搜尋語言與地區，支持 <code>&quot;en&quot;</code> 或 <code>&quot;ch&quot;</code>。</p>
<hr>
<h3 id="日誌與結果"><a href="#日誌與結果" class="headerlink" title="日誌與結果"></a>日誌與結果</h3><ul>
<li>搜尋過程與結果會保存到指定的日誌文件中。</li>
<li>日誌包括搜尋引擎、搜尋結果數量、語言模型的輸入輸出 token 數等。</li>
</ul>
<hr>
<h3 id="相關連結"><a href="#相關連結" class="headerlink" title="相關連結"></a>相關連結</h3><ul>
<li><a href="/akasha/2024/12/26/%E6%96%87%E4%BB%B6%E6%90%9C%E5%B0%8B/">文件搜尋</a></li>
<li><a href="/akasha/2024/12/30/%E8%A8%AD%E5%AE%9A%E8%AA%9E%E8%A8%80%E6%A8%A1%E5%9E%8B/">設定語言模型</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E6%8F%90%E7%A4%BA%E6%A0%BC%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E6%8F%90%E7%A4%BA%E6%A0%BC%E5%BC%8F/" class="post-title-link" itemprop="url">提示格式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 21:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T21:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 11:41:08" itemprop="dateModified" datetime="2025-04-22T11:41:08+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="提示格式"><a href="#提示格式" class="headerlink" title="提示格式"></a>提示格式</h2><p>根據使用的語言模型不同，使用不同的格式來下指令可以得到更好的結果，akasha目前提供 <em><strong>gpt</strong></em>, <em><strong>llama</strong></em>, <em><strong>chat_gpt</strong></em>, <em><strong>chat_mistral</strong></em>, <em><strong>chat_gemini</strong></em>, <em><strong>auto</strong></em> 等格式<br>若選擇 <em><strong>auto</strong></em>會根據模型類別來決定提示格式 </p>
<h4 id="gpt"><a href="#gpt" class="headerlink" title="gpt"></a>gpt</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">prompt_format = System: &#123;system_prompt&#125; \n\n &#123;history_messages&#125; \n\n Human: &#123;prompt&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="llama"><a href="#llama" class="headerlink" title="llama"></a>llama</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">prompt_format = [INST] &lt;&lt;SYS&gt;&gt;  &#123;system_prompt&#125; \n\n &lt;&lt;SYS&gt;&gt; &#123;history_messages&#125; \n\n  &#123;prompt&#125; [\INST]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="chat-gpt"><a href="#chat-gpt" class="headerlink" title="chat_gpt"></a>chat_gpt</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">prompt_format = [&#123;&quot;role&quot;:&quot;system&quot;, &quot;content&quot;: &#123;system_prompt&#125; &#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;user&quot;, &quot;content&quot;: &#123;history msg1&#125;&#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;assistant&quot;, &quot;content&quot;: &#123;history msg2&#125;&#125;,</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&#123;&quot;role&quot;:&quot;user&quot;, &quot;content&quot;: &#123;prompt&#125;&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="chat-mistral"><a href="#chat-mistral" class="headerlink" title="chat_mistral"></a>chat_mistral</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">prompt_format = [&#123;&quot;role&quot;:&quot;user&quot;, &quot;content&quot;: &quot;start conversation&quot; &#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;assistant&quot;, &quot;content&quot;: &#123;system_prompt&#125;&#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;user&quot;, &quot;content&quot;: &#123;history msg1&#125;&#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;assistant&quot;, &quot;content&quot;: &#123;history msg2&#125;&#125;,</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&#123;&quot;role&quot;:&quot;user&quot;, &quot;content&quot;: &#123;prompt&#125;&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="chat-gemini"><a href="#chat-gemini" class="headerlink" title="chat_gemini"></a>chat_gemini</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">prompt_format =[&#123;&quot;role&quot;:&quot;model&quot;, &quot;parts&quot;: [&#123;system_prompt&#125;]&#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;user&quot;, &quot;parts&quot;: [&#123;history msg1&#125;]&#125;,</span><br><span class="line">&#123;&quot;role&quot;:&quot;model&quot;, &quot;parts&quot;: [&#123;history msg2&#125;]&#125;,</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&#123;&quot;role&quot;:&quot;user&quot;, &quot;parts&quot;: [&#123;prompt&#125;]&#125;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import akasha</span><br><span class="line">sys_prompt = &quot;請用中文回答&quot;</span><br><span class="line">prompt = &quot;五軸是甚麼?&quot;</span><br><span class="line">qa = akasha.RAG(</span><br><span class="line">    verbose=False, </span><br><span class="line">    search_type=&quot;svm&quot;, </span><br><span class="line">    model=&quot;openai:gpt-3.5-turbo&quot;,</span><br><span class="line">    prompt_format_type=&quot;chat_gpt&quot;)</span><br><span class="line"></span><br><span class="line">response = qa(</span><br><span class="line">        data_source=&quot;docs/mic/&quot;,</span><br><span class="line">        prompt=prompt,</span><br><span class="line">        system_prompt=sys_prompt,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


<h2 id="Example2"><a href="#Example2" class="headerlink" title="Example2"></a>Example2</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import akasha</span><br><span class="line">import akasha.helper as ah</span><br><span class="line">from akasha.utils.prompts.gen_prompt import format_sys_prompt</span><br><span class="line"></span><br><span class="line">sys_prompt = &quot;請用中文回答&quot;</span><br><span class="line">prompt_format = &quot;chat_gpt&quot;</span><br><span class="line">prompt = &quot;五軸是甚麼?&quot;</span><br><span class="line">input_text = format_sys_prompt(sys_prompt,prompt,prompt_format)</span><br><span class="line">model_obj = akasha.handle_model(&quot;openai:gpt-3.5-turbo&quot;,False,0.0)</span><br><span class="line"></span><br><span class="line">response = ah.call_model(model_obj, input_text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E6%96%87%E4%BB%B6%E6%90%9C%E5%B0%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E6%96%87%E4%BB%B6%E6%90%9C%E5%B0%8B/" class="post-title-link" itemprop="url">文件搜尋</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 20:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T20:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 15:22:06" itemprop="dateModified" datetime="2025-04-22T15:22:06+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="選擇不同的文件搜尋方法"><a href="#選擇不同的文件搜尋方法" class="headerlink" title="選擇不同的文件搜尋方法"></a>選擇不同的文件搜尋方法</h2><p>使用<em><strong>search_type</strong></em>參數可選擇不同的文件搜尋方法去找出與問題相關的文件段落，可使用<em><strong>svm</strong></em>, <em><strong>mmr</strong></em>, <em><strong>tfidf</strong></em>, <em><strong>knn</strong></em>。另可使用<em><strong>merge</strong></em>，為前三者的合併。</p>
<ol>
<li><p><em><strong>支持向量機（svm）</strong></em> 使用輸入提示和文件向量來訓練svm模型，訓練後，svm可用於基於其與訓練數據的相似性對新向量進行評分。</p>
</li>
<li><p><em><strong>Max Marginal Relevance（mmr）</strong></em> 通過余弦相似度選擇相似的文件，但它也考慮多樣性，因此它還會懲罰與已選擇文件的接近。</p>
</li>
<li><p><em><strong>詞頻-逆文檔頻率（tfidf）</strong></em> 是信息檢索和文本挖掘中常用的權重技術。TF-IDF是一種統計方法，用於評估詞語在一個文檔集合或語料庫中相對於該集合中的一個特定文檔的重要性。</p>
</li>
<li><p><em><strong>K-最近鄰居（KNN）</strong></em> 是一種機器學習算法，用於分類和回歸問題。對於新數據點，它計算其與已知數據點的距離，然後基於最近的 k 個鄰居來預測類別或數值。在分類中，以多數票決定類別，而在回歸中則計算鄰居的平均值。</p>
</li>
<li><p><em><strong>Okapi BM25(bm25)</strong></em>（BM 是最佳匹配的縮寫）是一種基於查詢詞出現在每個文檔中的檢索功能，而不考慮它們在文檔中的相鄰關系的排名一組文檔的方法。它是一系列具有略有不同組件和參數的評分函數。</p>
</li>
<li><p><em><strong>rerank</strong></em> 使用bge-reranker模型對文檔進行相似度排序，速度較慢。 (rerank&#x2F;rerank:bge-reranker-large)</p>
</li>
</ol>
</br>
</br>


<h2 id="自動選擇搜尋方法"><a href="#自動選擇搜尋方法" class="headerlink" title="自動選擇搜尋方法"></a>自動選擇搜尋方法</h2><p><em><strong>auto</strong></em>&#x2F; <em><strong>audo_rerank</strong></em> 是另一種可以選擇的文件搜尋策略，使用 <em><strong>bm25</strong></em> 來搜尋相同詞語的文件，並用 <em><strong>svm</strong></em> 搜尋近似詞意的文件，若為 <em><strong>audo_rerank</strong></em> 且兩者皆沒有找到，則使用rerank模型去遍歷文件，但會相當緩慢。</p>
<h2 id="自訂搜尋方法"><a href="#自訂搜尋方法" class="headerlink" title="自訂搜尋方法"></a>自訂搜尋方法</h2><p>如果你希望設計自己的方法找尋最相似的文檔，可以建立search_type函數，並將此函數作為<em><strong>search_type</strong></em>參數</p>
<p>此函數輸入包含:</p>
<h5 id="1-query-embeds-查詢的嵌入。（numpy-array）"><a href="#1-query-embeds-查詢的嵌入。（numpy-array）" class="headerlink" title="1.query_embeds: 查詢的嵌入。（numpy array）"></a>1.query_embeds: 查詢的嵌入。（numpy array）</h5><h5 id="2-docs-embeds-所有文檔的嵌入。（表示文檔嵌入的-numpy-數組的list）"><a href="#2-docs-embeds-所有文檔的嵌入。（表示文檔嵌入的-numpy-數組的list）" class="headerlink" title="2.docs_embeds: 所有文檔的嵌入。（表示文檔嵌入的 numpy 數組的list）"></a>2.docs_embeds: 所有文檔的嵌入。（表示文檔嵌入的 numpy 數組的list）</h5><h5 id="3-k-所要選擇的最相關文檔的數量。（integer）"><a href="#3-k-所要選擇的最相關文檔的數量。（integer）" class="headerlink" title="3.k: 所要選擇的最相關文檔的數量。（integer）"></a>3.k: 所要選擇的最相關文檔的數量。（integer）</h5><h5 id="4-log-一個字典，可用於記錄任何您希望記錄的其他信息。（dictionary）"><a href="#4-log-一個字典，可用於記錄任何您希望記錄的其他信息。（dictionary）" class="headerlink" title="4.log: 一個字典，可用於記錄任何您希望記錄的其他信息。（dictionary）"></a>4.log: 一個字典，可用於記錄任何您希望記錄的其他信息。（dictionary）</h5></br>
</br>

<h4 id="此函數須回傳相似文檔的index順序-list"><a href="#此函數須回傳相似文檔的index順序-list" class="headerlink" title="此函數須回傳相似文檔的index順序(list)"></a>此函數須回傳相似文檔的index順序(list)</h4></br>
</br>


<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>如範例，我們使用歐幾里得距離度量來識別最相關的文檔。它返回一個表示距離小於指定閾值的查詢和文檔嵌入之間的前 k 個文檔的索引列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import akasha</span><br><span class="line"></span><br><span class="line">def cust(query_embeds, docs_embeds, k:int, relevancy_threshold:float, log:dict):</span><br><span class="line">    </span><br><span class="line">    from scipy.spatial.distance import euclidean</span><br><span class="line">    import numpy as np</span><br><span class="line">    distance = [[euclidean(query_embeds, docs_embeds[idx]),idx] for idx in range(len(docs_embeds))]</span><br><span class="line">    distance = sorted(distance, key=lambda x: x[0])</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ## change dist if embeddings not between 0~1</span><br><span class="line">    max_dist = 1</span><br><span class="line">    while max_dist &lt; distance[-1][0]:</span><br><span class="line">        max_dist *= 10</span><br><span class="line">        relevancy_threshold *= 10</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    ## add log para</span><br><span class="line">    log[&#x27;dd&#x27;] = &quot;miao&quot;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    return  [idx for dist,idx in distance[:k] if (max_dist - dist) &gt;= relevancy_threshold]</span><br><span class="line"></span><br><span class="line">doc_path = &quot;./mic/&quot;</span><br><span class="line">prompt = &quot;五軸是什麼?&quot;</span><br><span class="line"></span><br><span class="line">qa = akasha.RAG(verbose=True, search_type = cust, embeddings=&quot;hf:shibing624/text2vec-base-chinese&quot;)</span><br><span class="line">qa(data_source= doc_path, prompt = prompt)</span><br></pre></td></tr></table></figure>

</br>
</br>


<h2 id="Document-物件"><a href="#Document-物件" class="headerlink" title="Document 物件"></a>Document 物件</h2><p>在akasha中，文件搜尋的結果會以list of Document的形式回傳，Docuement為一個儲存文件內容(page_content)和後設資料(metadata)的物件，可以以此進行宣告和取用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.schema <span class="keyword">import</span> Document</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;這是一個測試文件段落，這是一個測試文件段落，這是一個測試文件段落。&quot;</span></span><br><span class="line">metadata = &#123;<span class="string">&#x27;page&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;source&#x27;</span>:<span class="string">&#x27;docs/test1/f1.txt&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">doc1 = Document(page_content=text, metadata=metadata)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(doc1.page_content)</span><br><span class="line"><span class="built_in">print</span>(doc1.metadata)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


</br>
</br>


<h2 id="Retriver"><a href="#Retriver" class="headerlink" title="Retriver"></a>Retriver</h2><p>若您想自行進行文件搜尋，在akasha中，文件搜尋是以以下流程進行:</p>
<ol>
<li>從文件資料夾中建立chromadb，讀取為dbs物件</li>
<li>根據搜尋方法取得retriever物件</li>
<li>利用retriever進行文件搜尋，並根據語言模型和設定的文件token上限回傳不超過token上限的文件內容，與文件的排序(list of Document)</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.retrievers.base <span class="keyword">import</span> get_retrivers</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.search_doc <span class="keyword">import</span> search_docs</span><br><span class="line"></span><br><span class="line">emb_name = <span class="string">&quot;openai:text-embedding-ada-002&quot;</span></span><br><span class="line">emb_obj = ah.handle_embeddings(emb_name)</span><br><span class="line">search_type = <span class="string">&quot;auto&quot;</span></span><br><span class="line">query = <span class="string">&quot;五軸是甚麼?&quot;</span></span><br><span class="line">model_name = <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span></span><br><span class="line">max_input_tokens = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. get dbs object</span></span><br><span class="line">db, _ = adb.process_db(data_source=<span class="string">&quot;docs/mic&quot;</span>, verbose=<span class="literal">False</span>, embeddings=emb_obj,</span><br><span class="line">                                 chunk_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. get retriver list</span></span><br><span class="line">retriver_list = get_retrivers(db=db, embeddings=emb_obj, </span><br><span class="line">                                search_type=search_type)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. get sorted list of Documents by similarity </span></span><br><span class="line">docs, doc_length, doc_tokens = akasha.search.search_docs(</span><br><span class="line">            retriver_list,</span><br><span class="line">            query,</span><br><span class="line">            model=model_name,</span><br><span class="line">            max_input_tokens=max_input_tokens,</span><br><span class="line">            search_type=search_type,</span><br><span class="line">            language=<span class="string">&quot;ch&quot;</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(docs[<span class="number">0</span>].page_content) <span class="comment"># docs is list of Documents</span></span><br><span class="line"><span class="built_in">print</span>(doc_length) <span class="comment"># integer</span></span><br><span class="line"><span class="built_in">print</span>(doc_tokens) <span class="comment"># integer</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="get-relevant-documents-and-scores"><a href="#get-relevant-documents-and-scores" class="headerlink" title="get_relevant_documents_and_scores"></a>get_relevant_documents_and_scores</h3><p>若您只想使用單一的搜尋方法(如 mmr, svm, knn, tfidf, bm25)，且不想限制文件的總token數量，可以使用 <em><strong>get_relevant_documents_and_scores</strong></em>取得文件排序結果(list of Documents)與相似度的分數(list of float)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.retrievers.base <span class="keyword">import</span> get_retrivers</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.search_doc <span class="keyword">import</span> search_docs</span><br><span class="line"></span><br><span class="line">emb_name = <span class="string">&quot;openai:text-embedding-ada-002&quot;</span></span><br><span class="line">emb_obj = ah.handle_embeddings(emb_name)</span><br><span class="line">search_type = <span class="string">&quot;auto&quot;</span></span><br><span class="line">query = <span class="string">&quot;五軸是甚麼?&quot;</span></span><br><span class="line">model_name = <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span></span><br><span class="line">max_input_tokens = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. get dbs object</span></span><br><span class="line">db, _ = adb.process_db(data_source=<span class="string">&quot;docs/mic&quot;</span>, verbose=<span class="literal">False</span>, embeddings=emb_obj,</span><br><span class="line">                                 chunk_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. get single retriver object </span></span><br><span class="line">single_retriver = get_retrivers(db=db, embeddings=emb_obj, </span><br><span class="line">                                search_type=search_type)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. get sorted list of Documents and scores by similarity </span></span><br><span class="line"><span class="comment">### this method is only for single search method, not for &#x27;merge&#x27; and &#x27;auto&#x27; ###</span></span><br><span class="line">docs, scores = single_retriver.get_relevant_documents_and_scores(query)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(docs[<span class="number">0</span>].page_content) <span class="comment"># docs is list of Document</span></span><br><span class="line"><span class="built_in">print</span>(scores[<span class="number">0</span>]) <span class="comment"># float</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(docs), <span class="built_in">len</span>(scores))</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="retri-docs"><a href="#retri-docs" class="headerlink" title="retri_docs"></a>retri_docs</h3><p>若您不想限制文件的總token數量，可以使用 <em><strong>retri_docs</strong></em>取得文件排序結果(list of Documents)<br>可根據參數 <em><strong>topK</strong></em>指定回傳的文件片段數量上限</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.retrievers.base <span class="keyword">import</span> get_retrivers</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.search_doc <span class="keyword">import</span> retri_docs</span><br><span class="line"></span><br><span class="line">emb_name = <span class="string">&quot;openai:text-embedding-ada-002&quot;</span></span><br><span class="line">emb_obj = ah.handle_embeddings(emb_name)</span><br><span class="line">search_type = <span class="string">&quot;auto&quot;</span></span><br><span class="line">query = <span class="string">&quot;五軸是甚麼?&quot;</span></span><br><span class="line">model_name = <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span></span><br><span class="line">max_input_tokens = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. get dbs object</span></span><br><span class="line">db, _ = adb.process_db(data_source=<span class="string">&quot;docs/mic&quot;</span>, verbose=<span class="literal">False</span>, embeddings=emb_obj,</span><br><span class="line">                                 chunk_size=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. get retriver list</span></span><br><span class="line">retriver_list = get_retrivers(db=db, embeddings=emb_obj, </span><br><span class="line">                                           search_type=search_type)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. get sorted list of Documents by similarity </span></span><br><span class="line">docs = retri_docs(</span><br><span class="line">            db,</span><br><span class="line">            retriver_list,</span><br><span class="line">            query,</span><br><span class="line">            search_type=search_type,</span><br><span class="line">            topK=topK</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(docs[<span class="number">0</span>].page_content) <span class="comment"># docs is list of Document</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E5%90%91%E9%87%8F%E8%B3%87%E6%96%99%E5%BA%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E5%90%91%E9%87%8F%E8%B3%87%E6%96%99%E5%BA%AB/" class="post-title-link" itemprop="url">向量資料庫</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 20:58:59" itemprop="dateCreated datePublished" datetime="2024-12-26T20:58:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 15:50:31" itemprop="dateModified" datetime="2025-04-22T15:50:31+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="dbs物件"><a href="#dbs物件" class="headerlink" title="dbs物件"></a>dbs物件</h2><p>在akasha中，chromadb建立完之後，會被儲存成dbs物件，會儲存chromadb中的文件內容、metadata、向量資料、unique id，並被使用於後續的vector similarity search。</p>
<p>該物件可以添加多個chromadb資料，也可與其他dbs物件互相結合，也可根據filter抽取出需要的向量資料。</p>
<h3 id="建立向量資料"><a href="#建立向量資料" class="headerlink" title="建立向量資料"></a>建立向量資料</h3><h4 id="process-db"><a href="#process-db" class="headerlink" title="process_db"></a>process_db</h4><p>process_db可對多個文件集(list of directory)建立chromadb，並回傳dbs物件與建立不成功的檔案list，若文件內容、使用嵌入模型、chunk size相等的chromadb已存在，則不會重新創建而直接讀取。</p>
<p>文件內容改變也會建立新的chromadb，設定參數ignore_check&#x3D;True則不進行文件內容更改與否的確認，可更快的進行chromadb的讀取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line">data_source = [<span class="string">&quot;docs/mic&quot;</span>, <span class="string">&quot;docs/1.pdf&quot;</span>, <span class="string">&quot;https://github.com/iii-org/akasha&quot;</span>]</span><br><span class="line">emb_name = <span class="string">&quot;openai:text-embedding-3-small&quot;</span></span><br><span class="line">db, ignore_files = adb.process_db(</span><br><span class="line">    data_source=data_source,</span><br><span class="line">    embeddings=emb_name,</span><br><span class="line">    chunk_size=<span class="number">1000</span></span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">### dbs object is a class that stores all information of the chromadb ###</span></span><br><span class="line">db.get_docs()</span><br><span class="line">db.get_embeds()</span><br><span class="line">db.get_metadatas</span><br><span class="line">db.get_ids()</span><br></pre></td></tr></table></figure>

</br>
</br>

<h3 id="使用dbs物件"><a href="#使用dbs物件" class="headerlink" title="使用dbs物件"></a>使用dbs物件</h3><h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><p>您可以直接宣告akasha.utils.db.dbs()建立空的dbs物件，也可以利用已建立的chromadb建立dbs物件。</p>
<p>dbs物件包含ids(每個文字段落的unique id), embeds(每個文字段落的向量), metadatas(每個文字段落的後設資料), docs(每個文字段落的內容) 。 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line">db1 = adb.dbs()</span><br><span class="line"></span><br><span class="line"><span class="comment">### use chromadb to initialize dbs object ###</span></span><br><span class="line">storage_directory = <span class="string">&quot;chromadb/12345&quot;</span></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line">docsearch = Chroma(persist_directory=storage_directory,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line">db2 = adb.dbs(docsearch)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h4><p>dbs物件之間可以使用.merge相互結合</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line">db1 = adb.dbs(docsearch1)</span><br><span class="line"></span><br><span class="line">docsearch2 = Chroma(persist_directory=<span class="string">&quot;chromadb/456&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line">db2 = adb.dbs(docsearch2)</span><br><span class="line"></span><br><span class="line">db2.merge(db1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db2.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="add-chromadb"><a href="#add-chromadb" class="headerlink" title="add_chromadb"></a>add_chromadb</h4><p>dbs物件可以添加新的chromadb資料</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">docsearch2 = Chroma(persist_directory=<span class="string">&quot;chromadb/456&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">db = adb.dbs(docsearch1)</span><br><span class="line"></span><br><span class="line">db.add_chromadb(docsearch2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="get-Documents"><a href="#get-Documents" class="headerlink" title="get_Documents"></a>get_Documents</h4><p>使用get_Docuemnts可以得到當前dbs物件中儲存的Documents list (包含page_contents文件內容和metadata後設資料)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">db = adb.dbs(docsearch1)</span><br><span class="line"></span><br><span class="line">docs = db.get_Documents()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>([doc.page_contents <span class="keyword">for</span> doc <span class="keyword">in</span> docs])  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>([docs.metadata <span class="keyword">for</span> doc <span class="keyword">in</span> docs]) <span class="comment"># list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


</br>
</br>


<h3 id="載入chromadb"><a href="#載入chromadb" class="headerlink" title="載入chromadb"></a>載入chromadb</h3><p>成功建立chromadb後，若想再載入chromadb，可以使用 <em><strong>get_storage_directory</strong></em>取得chromadb路徑並進行載入，取得dbs物件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line">data_source = [<span class="string">&quot;docs/mic&quot;</span>]</span><br><span class="line">emb_name = <span class="string">&quot;openai:text-embedding-3-small&quot;</span></span><br><span class="line">chunk_size = <span class="number">1000</span></span><br><span class="line"><span class="comment">### create chromadb ###</span></span><br><span class="line">db, ignore_files = adb.process_db(</span><br><span class="line">    data_source=data_source,</span><br><span class="line">    embeddings=emb_name,</span><br><span class="line">    chunk_size=chunk_size,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### load chromadb ###</span></span><br><span class="line">embed_type, embed_name = emb_name.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">chromadb_mic_dir = adb.get_storage_directory(</span><br><span class="line">    <span class="string">&quot;docs/mic&quot;</span>, chunk_size, embed_type, embed_name</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">### after you created the chromadb, you can also load it by chroma_name ###</span></span><br><span class="line">chroma_list = [chromadb_mic_dir]</span><br><span class="line">db, ignore_files = adb.load_db_by_chroma_name(chroma_name_list=chroma_list)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="載入文件"><a href="#載入文件" class="headerlink" title="載入文件"></a>載入文件</h3><p>若不想建立向量資料庫，只需要載入文件，可以使用 <em><strong>load_docs_from_info</strong></em>單純載入文件成list of Documents</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line">data_source = [<span class="string">&quot;docs/mic&quot;</span>, <span class="string">&quot;docs/1.pdf&quot;</span>, <span class="string">&quot;https://github.com/iii-org/akasha&quot;</span>]</span><br><span class="line">docs = adb.load_docs_from_info(info=data_source, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(docs[<span class="number">0</span>].page_content)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




</br>
</br>

<h3 id="提取dbs物件"><a href="#提取dbs物件" class="headerlink" title="提取dbs物件"></a>提取dbs物件</h3><h4 id="extract-db-by-file"><a href="#extract-db-by-file" class="headerlink" title="extract_db_by_file"></a>extract_db_by_file</h4><p>extract_db_by_file可以將檔名符合file_name_list中的所有資料提取出來生成新的dbs物件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">db = adb.dbs(docsearch1)</span><br><span class="line">file_name_list = [<span class="string">&#x27;f1.txt&#x27;</span>, <span class="string">&#x27;f2.docx&#x27;</span>]</span><br><span class="line"></span><br><span class="line">extracted_db = adb.extract_db_by_file(db=db, file_name_list=file_name_list)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="extract-db-by-keyword"><a href="#extract-db-by-keyword" class="headerlink" title="extract_db_by_keyword"></a>extract_db_by_keyword</h4><p>extract_db_by_keyword可以將文字段落中存在任何keyword_list中keyword的所有資料提取出來生成新的dbs物件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">db = adb.dbs(docsearch1)</span><br><span class="line">keyword_list = [<span class="string">&quot;資訊產業策進會&quot;</span>, <span class="string">&quot;AI人工智慧&quot;</span>]</span><br><span class="line"></span><br><span class="line">extracted_db = adb.extract_db_by_keyword(db=db, keyword_list=keyword_list)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="extract-db-by-ids"><a href="#extract-db-by-ids" class="headerlink" title="extract_db_by_ids"></a>extract_db_by_ids</h4><p>extract_db_by_ids可以將存在id_list中的的所有資料提取出來生成新的dbs物件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">db = adb.dbs(docsearch1)</span><br><span class="line">id_list = [<span class="string">&#x27;2024-10-21-17_45_21_963065_0&#x27;</span>, <span class="string">&#x27;2024-10-21-17_45_23_601845_0&#x27;</span>]</span><br><span class="line"></span><br><span class="line">extracted_db = adb.extract_db_by_ids(db=db, id_list=id_list)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(extracted_db.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="pop-db-by-ids"><a href="#pop-db-by-ids" class="headerlink" title="pop_db_by_ids"></a>pop_db_by_ids</h4><p><em><strong>pop_db_by_ids</strong></em>會將所選id_list中的的所有資料從dbs物件中移除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">emb_obj = ah.handle_embeddings()</span><br><span class="line"></span><br><span class="line">docsearch1 = Chroma(persist_directory=<span class="string">&quot;chromadb/123&quot;</span>,</span><br><span class="line">                           embedding_function=emb_obj)</span><br><span class="line"></span><br><span class="line">db = adb.dbs(docsearch1)</span><br><span class="line">id_list = [<span class="string">&#x27;2024-10-21-17_45_21_963065_0&#x27;</span>, <span class="string">&#x27;2024-10-21-17_45_23_601845_0&#x27;</span>]</span><br><span class="line"></span><br><span class="line">adb.pop_db_by_ids(db=db, id_list=id_list)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_ids()))  <span class="comment"># list[str]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_embeds())) <span class="comment"># list[list[float]]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_metadatas())) <span class="comment">#list[dict]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(db.get_docs())) <span class="comment">#list[dict]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</br>
</br>

<h3 id="刪除chromadb內容"><a href="#刪除chromadb內容" class="headerlink" title="刪除chromadb內容"></a>刪除chromadb內容</h3><p>在akasha中，同個資料夾內的所有文件會儲存在同一個chromadb資料庫中，若你想刪除整個chromadb資料庫，可以使用 <em><strong>delete_documents_by_directory</strong></em><br>若要刪除單一文件，可以使用 <em><strong>delete_documents_by_file</strong></em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_chroma <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">data_source = [<span class="string">&quot;docs/mic&quot;</span>, <span class="string">&quot;docs/1.pdf&quot;</span>, <span class="string">&quot;https://github.com/iii-org/akasha&quot;</span>]</span><br><span class="line">emb_name = <span class="string">&quot;openai:text-embedding-3-small&quot;</span></span><br><span class="line">chunk_size = <span class="number">1000</span></span><br><span class="line"><span class="comment">### create chromadb ###</span></span><br><span class="line">db, ignore_files = adb.process_db(</span><br><span class="line">    data_source=data_source,</span><br><span class="line">    embeddings=emb_name,</span><br><span class="line">    chunk_size=chunk_size,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">delete_num = adb.delete_documents_by_file(</span><br><span class="line">    <span class="string">&quot;docs/1.pdf&quot;</span>, emb_name , chunk_size,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">delete_num = adb.delete_documents_by_directory(</span><br><span class="line">    <span class="string">&quot;docs/mic&quot;</span>, emb_name, chunk_size</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E8%BC%94%E5%8A%A9%E5%87%BD%E6%95%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E8%BC%94%E5%8A%A9%E5%87%BD%E6%95%B8/" class="post-title-link" itemprop="url">輔助函數</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 19:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T19:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 16:29:21" itemprop="dateModified" datetime="2025-04-22T16:29:21+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="AiiDO"><a href="#AiiDO" class="headerlink" title="AiiDO"></a>AiiDO</h2><p>akasha也可以利用AiiDO來保存執行紀錄，您需要在 AiiDO 平台上創建一個項目。完成後，您將收到自動上傳實驗所需的所有參數。<br>在程序的同一目錄下創建一個 .env 文件，並貼上所有參數。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">##.env file</span><br><span class="line">MINIO_URL= YOUR_MINIO_URL</span><br><span class="line">MINIO_USER= YOUR_MINIO_USER</span><br><span class="line">MINIO_PASSWORD= YOUR_MINIO_PASSWORD</span><br><span class="line">TRACKING_SERVER_URI= YOUR_TRACKING_SERVER_URI</span><br></pre></td></tr></table></figure>



<p>在創建了 .env 文件之後，您可以使用 record_exp 來設置實驗名稱，它將自動記錄實驗指標和結果到 mlflow 服務器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import akasha</span><br><span class="line">import os</span><br><span class="line">from dotenv import load_dotenv</span><br><span class="line">load_dotenv() </span><br><span class="line"></span><br><span class="line">os.environ[&quot;OPENAI_API_KEY&quot;] = &quot;your openAI key&quot;</span><br><span class="line"></span><br><span class="line">data_source = &quot;doc/&quot;</span><br><span class="line">prompt = &quot;「塞西莉亞花」的花語是什麼?	「失之交臂的感情」	「赤誠的心」	「浪子的真情」	「無法挽回的愛」&quot;</span><br><span class="line">exp_name = &quot;exp_akasha_get_response&quot;</span><br><span class="line">ak = akasha.RAG(record_exp=exp_name)</span><br><span class="line">response = ak.(data_source, prompt)</span><br></pre></td></tr></table></figure>

</br>
</br>


<h4 id="在你指定的實驗名稱中，可以看到不同次實驗的紀錄，每個紀錄的名稱是embedding-search-type-and-model-name的組合"><a href="#在你指定的實驗名稱中，可以看到不同次實驗的紀錄，每個紀錄的名稱是embedding-search-type-and-model-name的組合" class="headerlink" title="在你指定的實驗名稱中，可以看到不同次實驗的紀錄，每個紀錄的名稱是embedding, search type and model name的組合"></a>在你指定的實驗名稱中，可以看到不同次實驗的紀錄，每個紀錄的名稱是embedding, search type and model name的組合</h4><p><img src="https://hackmd.io/_uploads/rkSjnt19p.png" alt="upload_experiments"></p>
</br>
</br>

<h4 id="你也可以直接比較不同次實驗的結果"><a href="#你也可以直接比較不同次實驗的結果" class="headerlink" title="你也可以直接比較不同次實驗的結果"></a>你也可以直接比較不同次實驗的結果</h4><p><img src="https://hackmd.io/_uploads/SyvahY1qp.png" alt="response_comparison"></p>
</br>
</br>


<h2 id="call-model"><a href="#call-model" class="headerlink" title="call_model"></a>call_model</h2><p>若要呼叫語言模型，可以使用輔助函數call_model</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">from</span> akasha.utils.prompts.gen_prompt <span class="keyword">import</span> format_sys_prompt</span><br><span class="line"></span><br><span class="line">system_prompt = <span class="string">&quot;用中文回答&quot;</span></span><br><span class="line">prompt = <span class="string">&quot;五軸是什麼?&quot;</span></span><br><span class="line">model_obj = ah.handle_model(<span class="string">&quot;openai:gpt-e3.5-turbo&quot;</span>, <span class="literal">False</span>, <span class="number">0.0</span>)</span><br><span class="line">input_text = format_sys_prompt(system_prompt, prompt, <span class="string">&quot;gpt&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = ah.call_model(model_obj, input_text)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</br>
</br>


<h2 id="call-stream-model"><a href="#call-stream-model" class="headerlink" title="call_stream_model"></a>call_stream_model</h2><p>若要呼叫語言模型即時回答，可以使用輔助函數call_stream_model</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">from</span> akasha.utils.prompts.gen_prompt <span class="keyword">import</span> format_sys_prompt</span><br><span class="line"></span><br><span class="line">system_prompt = <span class="string">&quot;用中文回答&quot;</span></span><br><span class="line">prompt = <span class="string">&quot;五軸是什麼?&quot;</span></span><br><span class="line">model_obj = ah.handle_model(<span class="string">&quot;openai:gpt-e3.5-turbo&quot;</span>, <span class="literal">False</span>, <span class="number">0.0</span>)</span><br><span class="line">input_text = format_sys_prompt(system_prompt, prompt, <span class="string">&quot;gpt&quot;</span>)</span><br><span class="line"></span><br><span class="line">streaming = ah.call_stream_model(model_obj, input_text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> streaming:</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</br>
</br>


<h2 id="call-batch-model"><a href="#call-batch-model" class="headerlink" title="call_batch_model"></a>call_batch_model</h2><p>如果你有大量不需要連貫的推理需求，可以使用<strong>akasha.helper.call_batch_model</strong> 來進行批量推理來提升速度。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def call_batch_model(model: LLM, prompt: List[str], </span><br><span class="line">    system_prompt: Union[List[str], str] = &quot;&quot;) -&gt; List[str]:</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">from</span> akasha.utils.prompts.gen_prompt <span class="keyword">import</span> default_doc_grader_prompt</span><br><span class="line">model_obj = ah.handle_model(<span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>, <span class="literal">False</span>, <span class="number">0.0</span>)</span><br><span class="line"><span class="comment"># this prompt ask LLM to response &#x27;yes&#x27; or &#x27;no&#x27; if the document segment is relevant to the user question or not.</span></span><br><span class="line">SYSTEM_PROMPT = default_doc_grader_prompt() </span><br><span class="line">documents = [<span class="string">&quot;Doc1...&quot;</span>, <span class="string">&quot;Doc2...&quot;</span>, <span class="string">&quot;Doc3...&quot;</span>, <span class="string">&quot;Doc4...&quot;</span>]</span><br><span class="line">question = <span class="string">&quot;五軸是什麼?&quot;</span></span><br><span class="line"></span><br><span class="line">prompts = [<span class="string">&quot;document: &quot;</span> + doc +<span class="string">&quot;\n\n&quot;</span> + <span class="string">&quot;User Question: &quot;</span>+ question <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line"></span><br><span class="line">response_list = ah.call_batch_model(model_obj, prompt, SYSTEM_PROMPT)</span><br><span class="line"></span><br><span class="line"><span class="comment">## [&quot;yes&quot;, &quot;no&quot;, &quot;yes&quot;, &quot;yes&quot;]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


</br>
</br>


<h2 id="計算token數量"><a href="#計算token數量" class="headerlink" title="計算token數量"></a>計算token數量</h2><p><em><strong>Tokenizer.compute_tokens</strong></em>，此函數回傳該語言模型輸入的文字所需要的token數量<br><em><strong>get_doc_length</strong></em>，此函數使用jieba計算字串長度<br><em><strong>sim_to_trad</strong></em>，此函數將字串簡轉繁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;你是一個歷史學家詳細介紹札幌的歷史&quot;</span></span><br><span class="line">model =  <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span></span><br><span class="line">num_tokens = ah.myTokenizer.compute_tokens(</span><br><span class="line">    text=text, model_id=model)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(num_tokens)</span><br><span class="line"></span><br><span class="line"><span class="comment">### compute the length of the text by jieba ###</span></span><br><span class="line">doc_length = ah.get_doc_length(TEXT)</span><br><span class="line"></span><br><span class="line"><span class="comment">### translate simplified chinese to traditional chinese ###</span></span><br><span class="line">ret = ah.sim_to_trad(TEXT)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="從字串中取出dictionary"><a href="#從字串中取出dictionary" class="headerlink" title="從字串中取出dictionary"></a>從字串中取出dictionary</h2><p><em><strong>extract_json</strong></em>將字串中的json格式轉成字典，若找不到則回傳None</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line">TEXT2 = <span class="string">&quot;&quot;&quot;工業4.0是甚麼? </span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;title&quot;: &quot;工業4.0&quot;,</span></span><br><span class="line"><span class="string">  &quot;description&quot;: &quot;工業4.0是一場製造業的數位轉型，融合了物聯網、人工智慧與自動化技術，提升生產效率與靈活性。&quot; </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### get the json format dictionary from the text ###</span></span><br><span class="line">text_dict = ah.extract_json(TEXT2)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="相似度分數"><a href="#相似度分數" class="headerlink" title="相似度分數"></a>相似度分數</h2><p>此函式利用bert, rouge, llm計算兩字串的相似度分數(0~1)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"></span><br><span class="line">DEFAULT_MODEL = <span class="string">&quot;openai:gpt-4o&quot;</span></span><br><span class="line"></span><br><span class="line">rf1 = <span class="string">&quot;&quot;&quot;工業4.0是指智慧與互聯的生產系統，旨在感知、預測物理世界並與之互動，以便即時做出支持生產的決策。這一概念最早於2011年在漢諾威工業博覽會上提出，並被</span></span><br><span class="line"><span class="string">納入德國、美國、中國等國家的高科技產業發展策略中。工業4.0的核心在於利用物聯網、人工智慧、大數據等技術，將生產從自動化提升到智慧化，實現更高效的生</span></span><br><span class="line"><span class="string">產管理和決策。&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">rf2 = <span class="string">&quot;&quot;&quot;工業 4.0 是一種智慧與互聯的生產系統，旨在感知、預測物理世界並與之互動，以便即時做出支持生產的決策。  </span></span><br><span class="line"><span class="string">簡單來說，它利用像是物聯網、AI、大數據和雲端等技術，讓製造業更加智能化和自動化。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### use bert to get the similarity score ###</span></span><br><span class="line">bert_score = ah.get_bert_score(rf1, rf2)</span><br><span class="line"></span><br><span class="line"><span class="comment">### use rouge to get the similarity score ###</span></span><br><span class="line">rouge_score = ah.get_rouge_score(rf1, rf2)</span><br><span class="line"></span><br><span class="line"><span class="comment">### use llm to get the similarity score ###</span></span><br><span class="line">llm_score = ah.get_llm_score(rf1, rf2, DEFAULT_MODEL)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">代理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 18:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T18:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-05-09 16:05:00" itemprop="dateModified" datetime="2025-05-09T16:05:00+08:00">2025-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E5%8A%9F%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">功能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="agents"><a href="#agents" class="headerlink" title="agents"></a>agents</h2><p><code>agents</code> 代理可以讓語言模型能夠使用外部工具來回答問題。通過定義工具並將其與 <code>agents</code> 結合，語言模型可以執行複雜的任務，例如計算、網頁搜尋、數據處理等。<code>agents</code> 支援同步與非同步操作，並提供詳細的日誌記錄功能。</p>
<hr>
<h3 id="agents-功能"><a href="#agents-功能" class="headerlink" title="agents 功能"></a>agents 功能</h3><ol>
<li><strong>工具整合</strong>：支持將自定義工具或內建工具與語言模型結合使用。</li>
<li><strong>多輪對話</strong>：支持多輪對話，並根據上下文進行推理。</li>
<li><strong>流式輸出</strong>：支持流式輸出回答，適合需要即時回應的場景。</li>
<li><strong>日誌保存</strong>：支持保存執行過程與結果的日誌，便於後續分析。</li>
<li><strong>MCP 支援</strong>：可以作為 MCP（Model Context Protocol）客戶端，調用 MCP 伺服器上的工具。</li>
</ol>
<hr>
<h3 id="agents-範例"><a href="#agents-範例" class="headerlink" title="agents 範例"></a>agents 範例</h3><h4 id="定義自訂工具並使用"><a href="#定義自訂工具並使用" class="headerlink" title="定義自訂工具並使用"></a>定義自訂工具並使用</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定義一個工具來獲取今天的日期</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">today_f</span>():</span><br><span class="line">    now = datetime.now()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;today&#x27;s date: &quot;</span> + <span class="built_in">str</span>(now.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 創建工具</span></span><br><span class="line">today_tool = akasha.create_tool(</span><br><span class="line">    <span class="string">&quot;today_date_tool&quot;</span>,</span><br><span class="line">    <span class="string">&quot;This is the tool to get today&#x27;s date, the tool doesn&#x27;t have any input parameter.&quot;</span>,</span><br><span class="line">    today_f,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 創建 agent 並使用工具</span></span><br><span class="line">agent = akasha.agents(</span><br><span class="line">    tools=[today_tool],</span><br><span class="line">    model=<span class="string">&quot;openai:gpt-4o&quot;</span>,</span><br><span class="line">    temperature=<span class="number">1.0</span>,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    keep_logs=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 問問題並使用工具回答</span></span><br><span class="line">response = agent(<span class="string">&quot;今天幾月幾號?&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存日誌</span></span><br><span class="line">agent.save_logs(<span class="string">&quot;logs.json&quot;</span>)</span><br></pre></td></tr></table></figure>


<h4 id="使用內建工具"><a href="#使用內建工具" class="headerlink" title="使用內建工具"></a>使用內建工具</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.agent.agent_tools <span class="keyword">as</span> at</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用內建的網頁搜尋工具和 JSON 保存工具</span></span><br><span class="line">tool_list = [at.websearch_tool(search_engine=<span class="string">&quot;brave&quot;</span>), at.saveJSON_tool()]</span><br><span class="line"></span><br><span class="line">agent = akasha.agents(</span><br><span class="line">    tools=tool_list,</span><br><span class="line">    model=<span class="string">&quot;openai:gpt-4o&quot;</span>,</span><br><span class="line">    temperature=<span class="number">1.0</span>,</span><br><span class="line">    max_input_tokens=<span class="number">8000</span>,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    keep_logs=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 問問題並使用工具回答</span></span><br><span class="line">response = agent(<span class="string">&quot;用網頁搜尋工業4.0，並將資訊存成json檔iii.json&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存日誌</span></span><br><span class="line">agent.save_logs(<span class="string">&quot;logs.json&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="使用-MCP-伺服器上的工具"><a href="#使用-MCP-伺服器上的工具" class="headerlink" title="使用 MCP 伺服器上的工具"></a>使用 MCP 伺服器上的工具</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">from</span> langchain_mcp_adapters.client <span class="keyword">import</span> MultiServerMCPClient</span><br><span class="line"></span><br><span class="line">MODEL = <span class="string">&quot;openai:gpt-4o&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定義 MCP 伺服器連接資訊</span></span><br><span class="line">connection_info = &#123;</span><br><span class="line">    <span class="string">&quot;math&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;command&quot;</span>: <span class="string">&quot;python&quot;</span>,</span><br><span class="line">        <span class="string">&quot;args&quot;</span>: [<span class="string">&quot;cal_server.py&quot;</span>],</span><br><span class="line">        <span class="string">&quot;transport&quot;</span>: <span class="string">&quot;stdio&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;weather&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://localhost:8000/sse&quot;</span>,</span><br><span class="line">        <span class="string">&quot;transport&quot;</span>: <span class="string">&quot;sse&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">prompt = <span class="string">&quot;tell me the weather in Taipei&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 MCP 工具</span></span><br><span class="line">agent = akasha.agents(</span><br><span class="line">    model=MODEL,</span><br><span class="line">    temperature=<span class="number">1.0</span>,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    keep_logs=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># 問問題並使用 MCP 工具回答</span></span><br><span class="line">response = akasha.call_mcp_agent(agent, connection_info, prompt)</span><br><span class="line"><span class="comment"># 保存日誌</span></span><br><span class="line">agent.save_logs(<span class="string">&quot;logs_agent.json&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="agents-參數"><a href="#agents-參數" class="headerlink" title="agents 參數"></a>agents 參數</h3><h4 id="初始化參數"><a href="#初始化參數" class="headerlink" title="初始化參數"></a>初始化參數</h4><h5 id="tools-List-BaseTool"><a href="#tools-List-BaseTool" class="headerlink" title="tools: List[BaseTool]"></a>tools: List[BaseTool]</h5><p>工具列表，可以是自定義工具或內建工具。</p>
<h5 id="model-str"><a href="#model-str" class="headerlink" title="model: str"></a>model: str</h5><p>使用的語言模型，例如 <code>&quot;openai:gpt-4o&quot;</code> 或 <code>&quot;openai:gpt-3.5-turbo&quot;</code>。</p>
<h5 id="temperature-float"><a href="#temperature-float" class="headerlink" title="temperature: float"></a>temperature: float</h5><p>語言模型的隨機性參數，範圍為 0.0 到 1.0。</p>
<h5 id="max-input-tokens-int"><a href="#max-input-tokens-int" class="headerlink" title="max_input_tokens: int"></a>max_input_tokens: int</h5><p>單次輸入模型的最大 token 數。</p>
<h5 id="max-output-tokens-int"><a href="#max-output-tokens-int" class="headerlink" title="max_output_tokens: int"></a>max_output_tokens: int</h5><p>模型輸出的最大 token 數。</p>
<h5 id="max-round-int"><a href="#max-round-int" class="headerlink" title="max_round: int"></a>max_round: int</h5><p>多輪對話的最大輪數。</p>
<h5 id="max-past-observation-int"><a href="#max-past-observation-int" class="headerlink" title="max_past_observation: int"></a>max_past_observation: int</h5><p>發送給模型的過去觀察數量。</p>
<h5 id="prompt-format-type-str"><a href="#prompt-format-type-str" class="headerlink" title="prompt_format_type: str"></a>prompt_format_type: str</h5><p>提示格式類型，例如 <code>&quot;auto&quot;</code>、<code>&quot;gpt&quot;</code>、<code>&quot;llama&quot;</code>。</p>
<h5 id="retri-observation-bool"><a href="#retri-observation-bool" class="headerlink" title="retri_observation: bool"></a>retri_observation: bool</h5><p>是否啟用觀察檢索。</p>
<h5 id="keep-logs-bool"><a href="#keep-logs-bool" class="headerlink" title="keep_logs: bool"></a>keep_logs: bool</h5><p>是否保存執行過程與結果的日誌。</p>
<h5 id="verbose-bool"><a href="#verbose-bool" class="headerlink" title="verbose: bool"></a>verbose: bool</h5><p>是否顯示詳細的執行過程。</p>
<h5 id="stream-bool"><a href="#stream-bool" class="headerlink" title="stream: bool"></a>stream: bool</h5><p>是否啟用流式輸出。</p>
<hr>
<h3 id="call-參數"><a href="#call-參數" class="headerlink" title="call 參數"></a><strong>call</strong> 參數</h3><h5 id="question-str"><a href="#question-str" class="headerlink" title="question: str"></a>question: str</h5><p>使用者的問題。</p>
<h5 id="messages-List-dict"><a href="#messages-List-dict" class="headerlink" title="messages: List[dict]"></a>messages: List[dict]</h5><p>需要一併提供給語言模型的對話紀錄。</p>
<hr>
<h3 id="日誌與結果"><a href="#日誌與結果" class="headerlink" title="日誌與結果"></a>日誌與結果</h3><ul>
<li>執行過程與結果會保存到指定的日誌文件中。</li>
<li>日誌包括工具使用情況、語言模型的輸入輸出 token 數等。</li>
</ul>
<hr>
<h3 id="相關連結"><a href="#相關連結" class="headerlink" title="相關連結"></a>相關連結</h3><ul>
<li><a href="/akasha/2024/12/26/%E6%96%87%E4%BB%B6%E6%90%9C%E5%B0%8B/">文件搜尋</a></li>
<li><a href="/akasha/2024/12/30/%E8%A8%AD%E5%AE%9A%E8%AA%9E%E8%A8%80%E6%A8%A1%E5%9E%8B/">設定語言模型</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E6%B5%81%E8%BC%B8%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E6%B5%81%E8%BC%B8%E5%87%BA/" class="post-title-link" itemprop="url">流輸出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 17:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T17:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 11:58:18" itemprop="dateModified" datetime="2025-04-22T11:58:18+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="call-stream-model"><a href="#call-stream-model" class="headerlink" title="call_stream_model"></a>call_stream_model</h2><p>在輔助函數中，若LLM模型為若為<em><strong>openai</strong></em>, <em><strong>huggingface</strong></em>, <em><strong>remote</strong></em>, <em><strong>gemini</strong></em>, <em><strong>anthropic</strong></em>類模型，可以使用akasha.call_stream_model()來得到流輸出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line">prompt = <span class="string">&quot;say something.&quot;</span></span><br><span class="line">model_obj = ah.handle_model(<span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>, <span class="literal">False</span>, <span class="number">0.0</span>)</span><br><span class="line">streaming = ah.call_stream_model(model_obj, prompt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> streaming:</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="RAG-stream"><a href="#RAG-stream" class="headerlink" title="RAG stream"></a>RAG stream</h2><p>RAG, ask, summary class的函式皆可使用參數stream&#x3D;True來得到流輸出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"></span><br><span class="line">ak = akasha.RAG(stream=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">streaming = ak(<span class="string">&quot;docs/mic&quot;</span>, <span class="string">&quot;say something&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> streaming:</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br></pre></td></tr></table></figure>


<h2 id="Stream-Output"><a href="#Stream-Output" class="headerlink" title="Stream Output"></a>Stream Output</h2><p>要在網頁上或API中使用流輸出(及時一個字一個字輸出語言模型回答)時，若為<em><strong>openai</strong></em>, <em><strong>huggingface</strong></em>, <em><strong>remote</strong></em>, <em><strong>gemini</strong></em>, <em><strong>anthropic</strong></em> 類模型，可以使用model_obj.stream(prompt)，以下為streamlit write_stream在網頁上即時輸出回答為範例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> streamlit <span class="keyword">as</span> st</span><br><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">import</span> gc, torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;pre&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> st.session_state:</span><br><span class="line">    st.session_state.pre = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;model_obj&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> st.session_state:</span><br><span class="line">    st.session_state.model_obj = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        gc.collect()</span><br><span class="line">        torch.cuda.ipc_collect()</span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream_response</span>(<span class="params">prompt:<span class="built_in">str</span>, model_name:<span class="built_in">str</span>=<span class="string">&quot;openai:gpt-3.5-turbo&quot;</span></span>):</span><br><span class="line">    <span class="comment"># Mistral-7B-Instruct-v0.3   Llama3-8B-Chinese-Chat</span></span><br><span class="line">    streaming = ah.call_stream_model(st.session_state.model_obj, prompt)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> streaming</span><br><span class="line"></span><br><span class="line">model = st.selectbox(<span class="string">&quot;select model&quot;</span>, [<span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>,<span class="string">&quot;hf:model/Mistral-7B-Instruct-v0.3&quot;</span>])</span><br><span class="line">prompt = st.chat_input(<span class="string">&quot;Say something&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> st.session_state.pre != model:</span><br><span class="line">    st.session_state.model_obj = <span class="literal">None</span></span><br><span class="line">    clean()</span><br><span class="line">    st.session_state.model_obj = akasha.helper.handle_model(model, <span class="literal">False</span>, <span class="number">0.0</span>)</span><br><span class="line">    st.session_state.pre = model</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> prompt:</span><br><span class="line">    st.write(<span class="string">&quot;question: &quot;</span> + prompt)</span><br><span class="line">    st.write_stream(stream_response(prompt, model))</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>使用model_obj &#x3D; akasha.helper.handle_model(model, False, 0.0)建立模型物件，當要使用推論時，使用akasha.helper.call_stream_model(model_obj, prompt)進行推論，可使用yield讓stream_response函式回傳generator, 便可即時輸出回答。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/FAST%20API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/FAST%20API/" class="post-title-link" itemprop="url">FAST API</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 15:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T15:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 16:55:51" itemprop="dateModified" datetime="2025-04-22T16:55:51+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="API-使用手冊"><a href="#API-使用手冊" class="headerlink" title="API 使用手冊"></a>API 使用手冊</h2><p><code>akasha</code> 提供了一個 RESTful API 伺服器，允許使用者通過 HTTP 請求來調用其核心功能，包括摘要 (<code>summary</code>)、文件檢索與生成 (<code>RAG</code>)、提問 (<code>ask</code>)、以及網頁搜尋 (<code>websearch</code>)。</p>
<hr>
<h3 id="啟動-API-伺服器"><a href="#啟動-API-伺服器" class="headerlink" title="啟動 API 伺服器"></a>啟動 API 伺服器</h3><p>在終端啟動 API 伺服器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">akasha api -p 8000 -h 127.0.0.1</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-p</code>：指定伺服器的埠號（預設為 8000）。</li>
<li><code>-h</code>：指定伺服器的主機地址（預設為 <code>127.0.0.1</code>）。</li>
</ul>
<hr>
<h3 id="API-功能"><a href="#API-功能" class="headerlink" title="API 功能"></a>API 功能</h3><h4 id="1-提問-ask"><a href="#1-提問-ask" class="headerlink" title="1. 提問 (/ask)"></a>1. 提問 (<code>/ask</code>)</h4><p>使用語言模型回答問題，並可基於提供的內容進行回答。</p>
<h5 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">ask_data = &#123;</span><br><span class="line">    <span class="string">&quot;prompt&quot;</span>: <span class="string">&quot;太陽能電池技術?&quot;</span>,</span><br><span class="line">    <span class="string">&quot;info&quot;</span>: <span class="string">&quot;太陽能電池技術5塊錢&quot;</span>,</span><br><span class="line">    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;system_prompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;temperature&quot;</span>: <span class="number">0.0</span>,</span><br><span class="line">    <span class="string">&quot;env_config&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;OPENAI_API_KEY&quot;</span>: <span class="string">&quot;your_openai_key&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(<span class="string">&quot;http://127.0.0.1:8000/ask&quot;</span>, json=ask_data).json()</span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<h5 id="請求參數"><a href="#請求參數" class="headerlink" title="請求參數"></a>請求參數</h5><ul>
<li><strong><code>prompt</code></strong>: 使用者的問題。</li>
<li><strong><code>info</code></strong>: 提供的內容，可以是文字、文件路徑或網址。</li>
<li><strong><code>model</code></strong>: 使用的語言模型，例如 <code>&quot;openai:gpt-3.5-turbo&quot;</code>。</li>
<li><strong><code>system_prompt</code></strong>: 指示語言模型的輸出格式需求。</li>
<li><strong><code>temperature</code></strong>: 語言模型的隨機性參數。</li>
<li><strong><code>env_config</code></strong>: 環境變數配置，例如 API 金鑰。</li>
</ul>
<hr>
<h4 id="2-文件檢索與生成-RAG"><a href="#2-文件檢索與生成-RAG" class="headerlink" title="2. 文件檢索與生成 (/RAG)"></a>2. 文件檢索與生成 (<code>/RAG</code>)</h4><p>基於提供的文件資料來源，檢索相關內容並生成回答。</p>
<h5 id="範例-1"><a href="#範例-1" class="headerlink" title="範例"></a>範例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rag_data = &#123;</span><br><span class="line">    <span class="string">&quot;data_source&quot;</span>: <span class="string">&quot;docs/mic/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;prompt&quot;</span>: <span class="string">&quot;工業4.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;chunk_size&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;embedding_model&quot;</span>: <span class="string">&quot;openai:text-embedding-ada-002&quot;</span>,</span><br><span class="line">    <span class="string">&quot;threshold&quot;</span>: <span class="number">0.1</span>,</span><br><span class="line">    <span class="string">&quot;search_type&quot;</span>: <span class="string">&quot;auto&quot;</span>,</span><br><span class="line">    <span class="string">&quot;system_prompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max_input_tokens&quot;</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="string">&quot;temperature&quot;</span>: <span class="number">0.0</span>,</span><br><span class="line">    <span class="string">&quot;env_config&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;OPENAI_API_KEY&quot;</span>: <span class="string">&quot;your_openai_key&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(<span class="string">&quot;http://127.0.0.1:8000/RAG&quot;</span>, json=rag_data).json()</span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<h5 id="請求參數-1"><a href="#請求參數-1" class="headerlink" title="請求參數"></a>請求參數</h5><ul>
<li><strong><code>data_source</code></strong>: 文件資料來源，可以是目錄或文件路徑。</li>
<li><strong><code>prompt</code></strong>: 使用者的問題。</li>
<li><strong><code>chunk_size</code></strong>: 文件分塊大小。</li>
<li><strong><code>model</code></strong>: 使用的語言模型。</li>
<li><strong><code>embedding_model</code></strong>: 使用的嵌入模型。</li>
<li><strong><code>threshold</code></strong>: 檢索的相似性閾值。</li>
<li><strong><code>search_type</code></strong>: 檢索類型，例如 <code>&quot;auto&quot;</code>。</li>
<li><strong><code>system_prompt</code></strong>: 指示語言模型的輸出格式需求。</li>
<li><strong><code>max_input_tokens</code></strong>: 單次輸入的最大 token 數。</li>
<li><strong><code>temperature</code></strong>: 語言模型的隨機性參數。</li>
<li><strong><code>env_config</code></strong>: 環境變數配置。</li>
</ul>
<hr>
<h4 id="3-摘要-summary"><a href="#3-摘要-summary" class="headerlink" title="3. 摘要 (/summary)"></a>3. 摘要 (<code>/summary</code>)</h4><p>對提供的內容進行摘要，支援多種摘要方法。</p>
<h5 id="範例-2"><a href="#範例-2" class="headerlink" title="範例"></a>範例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">summary_data = &#123;</span><br><span class="line">    <span class="string">&quot;content&quot;</span>: <span class="string">&quot;docs/2.pdf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;summary_type&quot;</span>: <span class="string">&quot;reduce_map&quot;</span>,</span><br><span class="line">    <span class="string">&quot;summary_len&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="string">&quot;system_prompt&quot;</span>: <span class="string">&quot;用中文做500字摘要&quot;</span>,</span><br><span class="line">    <span class="string">&quot;env_config&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;OPENAI_API_KEY&quot;</span>: <span class="string">&quot;your_openai_key&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(<span class="string">&quot;http://127.0.0.1:8000/summary&quot;</span>, json=summary_data).json()</span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<h5 id="請求參數-2"><a href="#請求參數-2" class="headerlink" title="請求參數"></a>請求參數</h5><ul>
<li><strong><code>content</code></strong>: 需要摘要的內容，可以是文件路徑、網址或純文字。</li>
<li><strong><code>summary_type</code></strong>: 摘要方法，例如 <code>&quot;map_reduce&quot;</code> 或 <code>&quot;refine&quot;</code>。</li>
<li><strong><code>summary_len</code></strong>: 摘要的建議長度。</li>
<li><strong><code>model</code></strong>: 使用的語言模型。</li>
<li><strong><code>system_prompt</code></strong>: 指示語言模型的輸出格式需求。</li>
<li><strong><code>env_config</code></strong>: 環境變數配置。</li>
</ul>
<hr>
<h4 id="4-網頁搜尋-websearch"><a href="#4-網頁搜尋-websearch" class="headerlink" title="4. 網頁搜尋 (/websearch)"></a>4. 網頁搜尋 (<code>/websearch</code>)</h4><p>使用搜尋引擎搜尋問題相關的資訊，並使用語言模型整合回答。</p>
<h5 id="範例-3"><a href="#範例-3" class="headerlink" title="範例"></a>範例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">websearch_data = &#123;</span><br><span class="line">    <span class="string">&quot;prompt&quot;</span>: <span class="string">&quot;太陽能電池技術?&quot;</span>,</span><br><span class="line">    <span class="string">&quot;model&quot;</span>: <span class="string">&quot;openai:gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;system_prompt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;temperature&quot;</span>: <span class="number">0.0</span>,</span><br><span class="line">    <span class="string">&quot;env_config&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;SERPER_API_KEY&quot;</span>: <span class="string">&quot;your_serper_key&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;search_engine&quot;</span>: <span class="string">&quot;serper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;search_num&quot;</span>: <span class="number">5</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(<span class="string">&quot;http://127.0.0.1:8000/websearch&quot;</span>, json=websearch_data).json()</span><br><span class="line"><span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<h5 id="請求參數-3"><a href="#請求參數-3" class="headerlink" title="請求參數"></a>請求參數</h5><ul>
<li><strong><code>prompt</code></strong>: 使用者的問題。</li>
<li><strong><code>model</code></strong>: 使用的語言模型。</li>
<li><strong><code>system_prompt</code></strong>: 指示語言模型的輸出格式需求。</li>
<li><strong><code>temperature</code></strong>: 語言模型的隨機性參數。</li>
<li><strong><code>search_engine</code></strong>: 搜尋引擎，例如 <code>&quot;serper&quot;</code>、<code>&quot;brave&quot;</code> 或 <code>&quot;wiki&quot;</code>。</li>
<li><strong><code>search_num</code></strong>: 搜尋結果的數量。</li>
<li><strong><code>env_config</code></strong>: 環境變數配置。</li>
</ul>
<hr>
<h3 id="環境變數配置"><a href="#環境變數配置" class="headerlink" title="環境變數配置"></a>環境變數配置</h3><p>在請求中可以通過 <code>env_config</code> 傳遞環境變數，例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;OPENAI_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your_openai_key&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SERPER_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your_serper_key&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;BRAVE_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your_brave_key&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="API-返回格式"><a href="#API-返回格式" class="headerlink" title="API 返回格式"></a>API 返回格式</h3><p>所有 API 返回的 JSON 格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;response&quot;</span><span class="punctuation">:</span> <span class="string">&quot;回答內容或摘要&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success 或 fail&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;logs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;執行過程的詳細日誌&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;執行時間戳&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;warnings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;警告信息&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="相關連結"><a href="#相關連結" class="headerlink" title="相關連結"></a>相關連結</h3><ul>
<li>文件搜尋</li>
<li>設定語言模型</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/26/%E8%87%AA%E6%9F%A5%E8%A9%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/26/%E8%87%AA%E6%9F%A5%E8%A9%A2/" class="post-title-link" itemprop="url">自查詢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-26 13:59:59" itemprop="dateCreated datePublished" datetime="2024-12-26T13:59:59+08:00">2024-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-05-06 14:27:59" itemprop="dateModified" datetime="2025-05-06T14:27:59+08:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/%E9%80%B2%E9%9A%8E/" itemprop="url" rel="index"><span itemprop="name">進階</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="自查詢-Self-Query"><a href="#自查詢-Self-Query" class="headerlink" title="自查詢(Self Query)"></a>自查詢(Self Query)</h2><p>自查詢是指能夠自我查詢的檢索問題方法。透過結構化、包含metadata的文件集，能將使用者的問題先透過metadata進行篩選，再藉由向量來查詢語意相似的文檔，比起直接做向量查詢能更精確的找到需要的文件。</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>自查詢的流程為</p>
<h4 id="0-create-metadata"><a href="#0-create-metadata" class="headerlink" title="0. create metadata"></a>0. create metadata</h4><p>添加結構化資料到文件集與向量資料庫中</p>
<h4 id="1-query-constructor"><a href="#1-query-constructor" class="headerlink" title="1. query constructor"></a>1. query constructor</h4><p>將使用者問題轉換成 query(用來做向量查詢的字串)與filter(用來篩選文件集的metatada keywords)<br>例如，使用者問題為: A公司在2024年對電動車的銷售量為多少?</p>
<p>透過語言模型 將其轉換為</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;電動車的銷售量&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;and(eq(\&quot;公司名稱\&quot;, \&quot;A公司\&quot;), eq(\&quot;日期年\&quot;, \&quot;2024\&quot;))&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<h4 id="2-filter-translator"><a href="#2-filter-translator" class="headerlink" title="2. filter translator"></a>2. filter translator</h4><p>將filter處理為程式可執行的dictionary</p>
<h4 id="3-filter-docs"><a href="#3-filter-docs" class="headerlink" title="3. filter docs"></a>3. filter docs</h4><p>根據filter篩選需要的文件集</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;filter&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;$and&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span>&#x27;拜訪年&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;$eq&#x27;<span class="punctuation">:</span> &#x27;<span class="number">2024</span>&#x27;<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span>&#x27;公司名稱&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;$eq&#x27;<span class="punctuation">:</span> &#x27;A公司&#x27;<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="4-similarity-search"><a href="#4-similarity-search" class="headerlink" title="4. similarity search"></a>4. similarity search</h4><p>從篩選出來的文件集做向量相似度搜尋</p>
</br>
</br>

<h3 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h3><h4 id="1-load-db-from-data-source-and-add-metadata-to-db"><a href="#1-load-db-from-data-source-and-add-metadata-to-db" class="headerlink" title="1. load db from data source and add metadata to db"></a>1. load db from data source and add metadata to db</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line">data_source = [<span class="string">&quot;docs/pns_query_small&quot;</span>]</span><br><span class="line">embed_name = <span class="string">&quot;openai:text-embedding-3-small&quot;</span></span><br><span class="line">chunk_size = <span class="number">1000</span></span><br><span class="line">db, ignore_files = adb.process_db(</span><br><span class="line">    data_source=data_source, embeddings=embed_name, chunk_size=chunk_size, verbose=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### you should create your own metadata function to add metadata for every text chunks in the db ###</span></span><br><span class="line"><span class="comment">### in this example, we use the source(file name) of the text chunk to map text chunks and metadatas ###</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_metadata</span>(<span class="params">db: adb.dbs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;this function is used to add metadata to the old_db object.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        old_db (adb.dbs):</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        (adb.dbs):</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line">    <span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> metadata <span class="keyword">in</span> db.metadatas:</span><br><span class="line">        file_path = metadata[<span class="string">&quot;source&quot;</span>]  <span class="comment"># source is the file path</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> Path(file_path).<span class="built_in">open</span>(<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                dictionary = json.load(file)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># dictionary = helper.extract_json(text)</span></span><br><span class="line">            metadata[<span class="string">&quot;課別&quot;</span>] = dictionary[<span class="string">&quot;課別&quot;</span>]</span><br><span class="line">            metadata[<span class="string">&quot;業務擔當&quot;</span>] = dictionary[<span class="string">&quot;業務擔當&quot;</span>]</span><br><span class="line">            ddate = dictionary[<span class="string">&quot;拜訪日期&quot;</span>]</span><br><span class="line">            metadata[<span class="string">&quot;拜訪年&quot;</span>] = <span class="built_in">int</span>(ddate.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>])</span><br><span class="line">            metadata[<span class="string">&quot;拜訪月&quot;</span>] = <span class="built_in">int</span>(ddate.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">            metadata[<span class="string">&quot;產品&quot;</span>] = dictionary[<span class="string">&quot;產品&quot;</span>]</span><br><span class="line">            metadata[<span class="string">&quot;公司名稱&quot;</span>] = dictionary[<span class="string">&quot;公司名稱&quot;</span>]</span><br><span class="line">            metadata[<span class="string">&quot;大分類&quot;</span>] = dictionary[<span class="string">&quot;大分類&quot;</span>]</span><br><span class="line">            metadata[<span class="string">&quot;中分類&quot;</span>] = dictionary[<span class="string">&quot;中分類&quot;</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;JSONDecodeError: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_metadata(db)</span><br><span class="line">adb.update_db(db, data_source, embed_name, chunk_size=chunk_size)</span><br></pre></td></tr></table></figure>

</br>
</br>


<h4 id="2-use-self-query-to-filter-docs-and-use-query-for-similarity-search"><a href="#2-use-self-query-to-filter-docs-and-use-query-for-similarity-search" class="headerlink" title="2. use self-query to filter docs and use query for similarity search"></a>2. use self-query to filter docs and use query for similarity search</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">from</span> akasha.utils.search.retrievers.base <span class="keyword">import</span> get_retrivers</span><br><span class="line"><span class="keyword">import</span> akasha</span><br><span class="line"></span><br><span class="line">db, ignore_files = adb.process_db(</span><br><span class="line">    data_source=data_source, embeddings=embed_name, chunk_size=chunk_size, verbose=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line">prompt = <span class="string">&quot;A公司在2024年對電動車的銷售量為多少?&quot;</span></span><br><span class="line">search_type = <span class="string">&quot;knn&quot;</span></span><br><span class="line">model_obj = ah.handle_model(<span class="string">&quot;openai:gpt-4o&quot;</span>, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## each metadata attribute should include name, description and type(integer, float, string) ##</span></span><br><span class="line">metadata_field_info = [</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;拜訪年&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;此訪談紀錄的拜訪年份&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;拜訪月&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;此訪談紀錄的拜訪月份&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;業務擔當&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;業務的名稱&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;中分類&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;訪談產品的中等分類&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;公司名稱&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;訪談對象的公司名稱&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;大分類&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;訪談產品的大分類&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;產品&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;訪談的產品名稱/型號&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;課別&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;公司部門的課別名稱或代號&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">document_content_description = <span class="string">&quot;業務與客戶的訪談紀錄&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### use self-query to filter docs</span></span><br><span class="line">new_dbs, query, matched_fields = ah.self_query(</span><br><span class="line">    prompt, model_obj, db, metadata_field_info, document_content_description</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">### option1   use knn similarity search to sort docs from filtered docs</span></span><br><span class="line"></span><br><span class="line">retriver = get_retrivers(new_dbs, embed_name, threshold=<span class="number">0.0</span>, search_type=search_type)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">docs, scores = retriver.get_relevant_documents_and_scores(query)</span><br><span class="line"><span class="built_in">print</span>(docs)</span><br><span class="line"></span><br><span class="line"><span class="comment">### option2    use new_dbs(filtered docs) to run other akasha functions</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ak = akasha.RAG(</span><br><span class="line">    model=model_obj,</span><br><span class="line">    embeddings=embed_name,</span><br><span class="line">)</span><br><span class="line">resposne = ak(data_source=new_dbs, prompt=prompt)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</br>
</br>


<h3 id="自訂parser函式"><a href="#自訂parser函式" class="headerlink" title="自訂parser函式"></a>自訂parser函式</h3><p>若您使用的語言模型回答無法使用預設的parser找出query與filter，可以自訂一個parser函式，輸入為語言模型的回答(string)，輸出為[query(string), filter(dictionary)]。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">just_an_example</span>(<span class="params">input_text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="comment"># input_text :</span></span><br><span class="line">    <span class="comment">#```json</span></span><br><span class="line">    <span class="comment">#&#123;</span></span><br><span class="line">    <span class="comment">#   &quot;query&quot;: &quot;產品疑慮&quot;,</span></span><br><span class="line">    <span class="comment">#   &quot;filter&quot;: &quot;and(eq(\&quot;公司名稱\&quot;, \&quot;a公司\&quot;), eq(\&quot;拜訪年\&quot;, \&quot;2024\&quot;))&quot;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">    <span class="comment">#```</span></span><br><span class="line"></span><br><span class="line">    jstr = <span class="string">&#x27;&#123;&quot;$and&quot;: [&#123;&quot;公司名稱&quot;: &#123;&quot;$eq&quot;: &quot;a公司&quot;&#125;&#125;, &#123;&quot;拜訪年&quot;: &#123;&quot;$eq&quot;: &quot;2024&quot;&#125;&#125;]&#125;&#x27;</span></span><br><span class="line">    dic = json.loads(jstr)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;產品疑慮&quot;</span>, dic</span><br><span class="line"></span><br><span class="line"><span class="comment">### use self-query to filter docs</span></span><br><span class="line">new_dbs, query, matched_fields = ah.self_query(</span><br><span class="line">            prompt, model_obj, db, metadata_field_info,</span><br><span class="line">            document_content_description, just_an_example)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


</br>
</br>


<h2 id="loose-filter"><a href="#loose-filter" class="headerlink" title="loose filter"></a>loose filter</h2><p>使用參數 <em><strong>loose_filter&#x3D;True</strong></em>會將filter中的$and替換成$or，只要文件有符合任意attribute便會選取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akasha.utils.db <span class="keyword">as</span> adb</span><br><span class="line"><span class="keyword">import</span> akasha.helper <span class="keyword">as</span> ah</span><br><span class="line"><span class="comment">### use self-query to filter docs</span></span><br><span class="line"><span class="comment">## filter become &#x27;&#123;&quot;$or&quot;: [&#123;&quot;公司名稱&quot;: &#123;&quot;$eq&quot;: &quot;a公司&quot;&#125;&#125;, &#123;&quot;拜訪年&quot;: &#123;&quot;$eq&quot;: &quot;2024&quot;&#125;&#125;]&#125;&#x27;</span></span><br><span class="line">new_dbs, query, matched_fields = ah.self_query(</span><br><span class="line">            prompt, model_obj, db, metadata_field_info,</span><br><span class="line">            document_content_description, loose_filter = <span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://tea9297.github.io/akasha/2024/12/24/ui%E8%A8%AD%E5%AE%9A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/akasha/images/avatar.gif">
      <meta itemprop="name" content="Chih Chuan Chang<ccchang@iii.org.tw>">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="akasha 0.9 使用手冊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/akasha/2024/12/24/ui%E8%A8%AD%E5%AE%9A/" class="post-title-link" itemprop="url">ui設定</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2024-12-24 23:59:59" itemprop="dateCreated datePublished" datetime="2024-12-24T23:59:59+08:00">2024-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-04-22 17:01:50" itemprop="dateModified" datetime="2025-04-22T17:01:50+08:00">2025-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/akasha/categories/UI/" itemprop="url" rel="index"><span itemprop="name">UI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="環境變數"><a href="#環境變數" class="headerlink" title="環境變數"></a>環境變數</h2><p>在畫面左側Environment File Path中填入.env的檔案路徑(預設.&#x2F;.env)，需填入相關API KEY才能使用OPENAI、GEMINI等模型，或使用網頁搜尋功能</p>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>只要你安裝了akasha，便可以簡單使用akasha_ui，在terminal執行:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">akasha toy</span></span><br></pre></td></tr></table></figure>

<p>便可以在瀏覽器上<a target="_blank" rel="noopener" href="http://localhost:8501/">開啟</a>，開始使用akasha ui</p>
</br>
</br>


<h2 id="上傳文件檔"><a href="#上傳文件檔" class="headerlink" title="上傳文件檔"></a>上傳文件檔</h2><p>上傳你需要的文件檔案，並取資料夾名稱，創立知識庫。</p>
<p><em><strong>請注意文件檔只允許(.docx, .txt, .pdf)</strong></em></p>
<p><img src="https://hackmd.io/_uploads/B1glkq19a.png" alt="ui_upload"></p>
</br>
</br>

<h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><p>在設定頁面，可以選擇要詢問的知識庫和調整各種參數、選擇不同語言模型。</p>
<p><em><strong>若使用openAI模型，請在左側輸入 openAI的key，azure openAI則需要額外輸入url。</strong></em></p>
<p><img src="https://hackmd.io/_uploads/BJ0TRYJcT.png" alt="ui_setting"></p>
<h2 id="手動增加模型"><a href="#手動增加模型" class="headerlink" title="手動增加模型"></a>手動增加模型</h2><p>如果你想使用不同的語言模型，可以至<a target="_blank" rel="noopener" href="https://huggingface.co/">huggingface</a>下載模型到”&#x2F;model”資料夾，模型便會加至設定中</p>
<p><img src="https://hackmd.io/_uploads/SyS6g5yqa.png" alt="ui_model"></p>
<p>設定完成後，便可開始使用akasha ui</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/akasha/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/akasha/">1</a><span class="page-number current">2</span><a class="page-number" href="/akasha/page/3/">3</a><a class="extend next" rel="next" href="/akasha/page/3/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chih Chuan Chang<ccchang@iii.org.tw></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/akasha/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chih Chuan Chang<ccchang@iii.org.tw></span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/akasha/lib/anime.min.js"></script>
  <script src="/akasha/lib/velocity/velocity.min.js"></script>
  <script src="/akasha/lib/velocity/velocity.ui.min.js"></script>

<script src="/akasha/js/utils.js"></script>

<script src="/akasha/js/motion.js"></script>


<script src="/akasha/js/schemes/muse.js"></script>


<script src="/akasha/js/next-boot.js"></script>




  















  

  

</body>
</html>
